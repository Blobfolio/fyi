/*!
# FYI Msg: Prefix
*/

use crate::utility;
use std::{
	cmp::Ordering,
	fmt,
	hash::{
		Hash,
		Hasher,
	},
	mem,
	ops::Deref,
};



#[derive(Clone, Copy)]
/// # Prefix Buffer.
///
/// This is a simple fixed-array buffer to store custom prefixes for
/// [`MsgKind::Other`](`super::MsgKind::Other`). This is implemented as a custom struct in order to take
/// advantage of `Copy`, thus allowing the [`MsgKind`](`super::MsgKind`) enum to also implement
/// `Copy`.
///
/// ## Restrictions
///
/// Because the buffer is fixed at a length of `64` — including the label and
/// any ANSI formatting — this leaves 45 bytes for the label itself. Prefixes
/// exceeding this limit are silently ignored.
///
/// ## Safety
///
/// This struct is not intended to be interacted with directly. Nearly all of
/// its methods are unsafe and require sane data to function correctly.
///
/// While the buffer's length is fixed, only the "occupied" regions will
/// contain trusted, predictable data. The overflow is transmuted into `u8` from
/// [`std::mem::MaybeUninit`], so may be zeroes or may be random weirdness.
pub struct MsgPrefix {
	buf: [u8; 64],
	len: usize,
}

impl fmt::Debug for MsgPrefix {
	fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {
		f.debug_struct("MsgPrefix")
			.field("buf", &self)
			.finish()
	}
}

impl Default for MsgPrefix {
	#[inline]
	fn default() -> Self {
		Self {
			buf: [0; 64],
			len: 0,
		}
	}
}

impl Deref for MsgPrefix {
	type Target = [u8];
	#[inline]
	fn deref(&self) -> &Self::Target { &self.buf[0..self.len] }
}

impl Eq for MsgPrefix {}

impl Hash for MsgPrefix {
	#[inline]
	fn hash<H: Hasher>(&self, state: &mut H) {
		self.as_bytes().hash(state);
	}
}

impl Ord for MsgPrefix {
	#[inline]
	fn cmp(&self, other: &Self) -> Ordering {
		self.as_bytes().cmp(other.as_bytes())
	}
}

impl PartialEq for MsgPrefix {
	#[inline]
	fn eq(&self, other: &Self) -> bool {
		self.as_bytes() == other.as_bytes()
	}
}

impl PartialOrd for MsgPrefix {
	#[inline]
	fn partial_cmp(&self, other: &Self) -> Option<Ordering> {
		Some(self.as_bytes().cmp(other.as_bytes()))
	}
}

/// ## Casting.
///
/// These methods provide means of converting a `MsgPrefix` into other data
/// structures.
///
/// Note: this struct can also be dereferenced to `&[u8]`.
impl MsgPrefix {
	#[must_use]
	#[inline]
	/// # As Bytes.
	///
	/// Return the prefix as a slice.
	pub fn as_bytes(&self) -> &[u8] { self }

	#[must_use]
	#[inline]
	/// # As Pointer.
	///
	/// Return a raw pointer to the slice.
	pub const fn as_ptr(&self) -> *const u8 { self.buf.as_ptr() }

	#[must_use]
	#[inline]
	/// # As Str.
	///
	/// Return the prefix as a string slice.
	///
	/// ## Safety
	///
	/// The string's UTF-8 is not validated for sanity!
	pub unsafe fn as_str(&self) -> &str { std::str::from_utf8_unchecked(self) }
}

/// ## The rest!
///
/// There isn't really a lot going on here. Haha.
impl MsgPrefix {
	#[must_use]
	/// # New Instance (Unchecked).
	///
	/// Create a new instance using the given prefix and color.
	///
	/// ## Examples
	///
	/// ```no_run
	/// use fyi_msg::MsgPrefix;
	///
	/// let prefix = unsafe { MsgPrefix::new_unchecked(b"Hello", 199) };
	/// ```
	///
	/// ## Safety
	///
	/// The prefix must be valid UTF-8 and cannot exceed 45 bytes in length.
	pub unsafe fn new_unchecked(prefix: &[u8], color: u8) -> Self {
		let mut buf = [mem::MaybeUninit::<u8>::uninit(); 64];

		let len: usize = {
			let mut dst = buf.as_mut_ptr() as *mut u8;

			dst = write_ansi(dst, color);
			dst = utility::write_advance(dst, prefix.as_ptr(), prefix.len());
			utility::write_advance(dst, b":\x1b[0m ".as_ptr(), 6) as usize - buf.as_ptr() as *const u8 as usize
		};

		// Align and return!
		Self {
			buf: mem::transmute::<_, [u8; 64]>(buf),
			len
		}
	}

	#[must_use]
	#[inline]
	/// # Is Empty.
	///
	/// Returns `true` if the prefix is empty.
	pub const fn is_empty(&self) -> bool { 0 == self.len }

	#[must_use]
	#[inline]
	/// # Length.
	///
	/// Return the length of the prefix.
	pub const fn len(&self) -> usize { self.len }
}

/// # Write ANSI.
///
/// This simply writes the corresponding (opening) ANSI markup into the correct
/// spot and returns an adjusted pointer.
unsafe fn write_ansi(dst: *mut u8, color: u8) -> *mut u8 {
	static ANSI: [u8; 3207] = [27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 109,
		27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 51, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 52, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 53, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 54, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 55, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 56, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 57, 57, 109,
		27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 48, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 49, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 50, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 51, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 52, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 53, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 54, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 55, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 56, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 49, 57, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 48, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 49, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 50, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 51, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 53, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 54, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 55, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 56, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 52, 57, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 53, 48, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 53, 49, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 53, 50, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 53, 51, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 53, 52, 109, 27, 91, 49, 59, 51, 56, 59, 53, 59, 50, 53, 53, 109,
	];

	if color == 0 {
		utility::write_advance(dst, b"\x1b[0m".as_ptr(), 4)
	}
	else if color < 10 {
		utility::write_advance(dst, ANSI.as_ptr().add(((color - 1) * 11) as usize), 11)
	}
	else if color < 100 {
		utility::write_advance(dst, ANSI.as_ptr().add(99 + (color - 10) as usize * 12), 12)
	}
	else {
		utility::write_advance(dst, ANSI.as_ptr().add(1179 + (color - 100) as usize * 13), 13)
	}
}



#[cfg(test)]
mod tests {
	use super::*;

	#[test]
	fn t_prefix() {
		unsafe {
			let prefix = MsgPrefix::new_unchecked(b"Hello World", 199);
			assert_eq!(prefix.deref(), b"\x1b[1;38;5;199mHello World:\x1b[0m ");
			assert_eq!(prefix.len(), 30);
			assert!(! prefix.is_empty());
		}
	}

	#[test]
	fn t_ansi() {
		unsafe {
			let mut buf: [u8; 4] = [0; 4];
			write_ansi(buf.as_mut_ptr(), 0);
			assert_eq!(buf, *b"\x1b[0m");

			for i in 1..10 {
				let mut buf: [u8; 11] = [0; 11];
				write_ansi(buf.as_mut_ptr(), i);
				assert_eq!(
					String::from_utf8_unchecked(buf.to_vec()),
					format!("\x1b[1;38;5;{}m", i)
				);
			}

			for i in 10..100 {
				let mut buf: [u8; 12] = [0; 12];
				write_ansi(buf.as_mut_ptr(), i);
				assert_eq!(
					String::from_utf8_unchecked(buf.to_vec()),
					format!("\x1b[1;38;5;{}m", i)
				);
			}

			for i in 100..=255 {
				let mut buf: [u8; 13] = [0; 13];
				write_ansi(buf.as_mut_ptr(), i);
				assert_eq!(
					String::from_utf8_unchecked(buf.to_vec()),
					format!("\x1b[1;38;5;{}m", i)
				);
			}
		}
	}
}
